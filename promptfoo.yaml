configVersion: 1

description: Generate chat - Coordinator/Police/Crowd

providers:
  - id: openai:gpt-4o-mini
    config:
      temperature: 0.2
      maxOutputTokens: 256

prompts:
  - label: generate_chat
    raw: |
      Below is a brief description of {{agent}}:
      {{base_desc}}

      Below are {{agent}}'s memories:
      {{memory}}

      Current address: {{address}}
      Current time: {{current_time}}

      {{previous_context}}{{current_context}}
      {{agent}} starts a conversation with {{another}}. The following is their conversation log:
      <conversation_log>
      {{conversation}}
      </conversation_log>

      <conversation_rules>
      {{agent}} should not repeat content already present in <conversation_log>.
      </conversation_rules>

      Based on the above <conversation_log> and <conversation_rules>, what will {{agent}} say to {{another}} now?
      Output strictly the following JSON format, and do not include any extra information:
      {
          "{{agent}}": <what {{agent}} says>
      }

defaultTest:
  vars:
    agent: Coordinator
    another: Police
    base_desc: A coordinator who communicates clearly and avoids repetition.
    memory: ""
    address: 1 Test Street
    current_time: 2025-10-18 17:00
    previous_context: ""
    current_context: ""
    conversation: ""
  assert:
    - type: contains-json
    - type: contains
      value: "\"{{agent}}\":"
    - type: regex
      value: "\\{\\s*\"{{agent}}\"\\s*:\\s*\"[\\s\\S]+\"\\s*\\}"
    - type: not-contains
      value: "{{conversation}}"
    - type: javascript
      code: |
        let obj;
        try { obj = JSON.parse(output); } catch (e) { return { pass: false, reason: 'not JSON' }; }
        const reply = obj[vars.agent];
        if (typeof reply !== 'string') return { pass: false, reason: 'value is not a string' };
        const len = reply.length;
        if (len < 5) return { pass: false, reason: 'too short' };
        if (len > 160) return { pass: false, reason: 'too long' };
        return true;
    - type: javascript
      code: |
        const obj = JSON.parse(output);
        const reply = obj[vars.agent] || '';
        const ok = /you|please|thanks|thank you/.test(reply.toLowerCase());
        return ok ? true : { pass: false, reason: 'missing polite dialog tone words' };

tests:
  - description: Coordinator and Police - basic dialog
    vars:
      agent: Coordinator
      another: Police
      base_desc: A calm coordinator facilitating information sharing
      memory: Preparing incident briefing recently
      address: Pudong New Area, Shanghai
      current_time: 2025/10/18 17:00
      previous_context: ""
      current_context: ""
      conversation: "Coordinator: We need to prepare the briefing for tomorrow.\nPolice: Okay, I'll gather the reports tonight."

  - description: Police and Crowd - avoid repetition in long dialog
    vars:
      agent: Police
      another: Crowd
      base_desc: An officer giving concise instructions
      memory: Yesterday they discussed the event safety plan
      address: Zhongguancun, Beijing
      current_time: 2025/10/18 17:05
      previous_context: "They just confirmed the assembly point."
      current_context: ""
      conversation: "Police: The meeting point is at Gate A, 3rd floor.\nCrowd: Got it, we'll arrive early.\nPolice: Please remember the safety guidelines."

  - description: Crowd and Coordinator - includes context
    vars:
      agent: Crowd
      another: Coordinator
      base_desc: Values order and efficiency
      memory: "Task list completed: submitted forms, followed instructions"
      address: Nanshan District, Shenzhen
      current_time: 2025/10/18 17:10
      previous_context: "Currently in the hall, network is stable."
      current_context: "The manager reminded to submit on time."
      conversation: "Crowd: The document is almost done.\nCoordinator: Please send it to me ASAP."
